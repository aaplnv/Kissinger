<!doctype html>
<html>
    <head>
        <script src="https://telegram.org/js/telegram-web-app.js"> </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.0.5/es5/tex-chtml-full.js" type="text/javascript"></script>
        <script src="https://cdn.tailwindcss.com"></script>
         <script>
            function setThemeClass() {
                document.documentElement.className = Telegram.WebApp.colorScheme;
            }
            Telegram.WebApp.onEvent('themeChanged', setThemeClass);
            setThemeClass();
         </script>
         <meta charset="utf-8">
         <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/themes/prism-twilight.min.css" rel="stylesheet" />
         <style>
             body {
                 margin: 0;
                 padding: 0;
            }

             h1 {
                 font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu;
             }

             a {
                 color: var(--tg-theme-link-color, #2678b6);
             }

             .mainbagg {
                 background-color: var(--tg-theme-bg-color, #000000);
                 color-scheme: var(--tg-color-scheme);
             }

             .txtcol {
                 color: var(--tg-theme-text-color, #222222);
             }
         </style>
    </head>
    <body class="mainbagg txtcol">
        <div class="block font-sans ">
             {% set number = tid | int %}
            <h1 class="block text-3xl font-bold p-2">–ó–∞–¥–∞–Ω–∏–µ {{ number + 1 | int }} {{ emojistatus }}</h1>

            <details class="block text-lg bg-white p-1 w-auto mx-2 rounded border">
                <summary class="font-semibold">–£—Å–ª–æ–≤–∏–µ</summary>
                <div class="block text-sm">
                    {{ source|safe }}
                </div>
            </details>

            <div class="m-2">
                <h3>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</h3>
                <div class="editor language-python bg-slate-900 text-white border border-black h-60">print("Hello, world!")</div>
            </div>

        </div>

        <script type="module" id="code">
            import {CodeJar} from "https://medv.io/codejar/codejar.js?"
            const jar = new CodeJar(
                document.querySelector(".editor"),
                Prism.highlightElement
            )

            Telegram.WebApp.ready();
            Telegram.WebApp.MainButton.setText('üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å').show().onClick(function () { sendPayload(); });

            function sendPayload() {
                var success = true
                try {
                    Telegram.WebApp.MainButton.setText('üèÉ‚Äç‚ôÄÔ∏è –†–∞–±–æ—Ç–∞–µ–º...').show().onClick(function () {
                    });
                    var data = {
                        // TODO: Use safe data only
                        query_id: Telegram.WebApp.initDataUnsafe.query_id,
                        code: jar.toString(),
                        userid: Telegram.WebApp.initDataUnsafe.user.id,
                    };
                    var json = JSON.stringify(data);
                    var xhr = new XMLHttpRequest();

                    xhr.open("POST", "/group/{{ gid }}/var/{{ vid }}/task/{{ tid }}");


                    xhr.setRequestHeader("Content-Type", "application/json");
                    xhr.send(json);

                    xhr.onreadystatechange = function() {
	                    if (this.readyState == 4 && this.status != 200) {
	                        success = false
                        }
	                };
                }
                catch (exception) {
                    success = false
                    console.log(exception)
                }
                finally {
                    if (success) {webviewClose()}
                    else {errorThrow()}
                }
            }

            function webviewClose() {
                Telegram.WebApp.close();
            }

            function errorThrow() {
                Telegram.WebApp.MainButton.setText('üò∞ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞').show();
            }

        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/components/prism-core.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.20.0/plugins/autoloader/prism-autoloader.min.js"></script>
    </body>
</html>